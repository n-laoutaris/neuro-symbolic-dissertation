@prefix : <http://example.org/schema#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .

#
# Shape: citizenship_shape
# Description: The student must be a Greek citizen or a citizen of another European Union country.
#
:citizenship_shape
    a sh:NodeShape ;
    sh:targetClass :Applicant ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "The student is not a Greek citizen or a citizen of another European Union country." ;
        sh:select """
            SELECT ?this
            WHERE {
                ?this :citizenshipCountry ?country .
                FILTER(?country NOT IN ("GR", "AT", "BE", "BG", "HR", "CY", "CZ", "DK", "EE", "FI", "FR", "DE", "HU", "IE", "IT", "LV", "LT", "LU", "MT", "NL", "PL", "PT", "RO", "SK", "SI", "ES", "SE"))
            }
        """ ;
    ] .

#
# Shape: academic_status_shape
# Description: The student must be enrolled in a Higher Education Institution (HEI) and possess a valid academic ID.
#
:academic_status_shape
    a sh:NodeShape ;
    sh:targetClass :Applicant ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "The student is not enrolled in a Higher Education Institution or does not possess a valid academic ID." ;
        sh:select """
            SELECT ?this
            WHERE {
                FILTER NOT EXISTS {
                    ?this :hasEducation ?edu .
                    ?edu :isEnrolledAt ?hei .
                    ?edu :hasValidAcademicID true .
                }
            }
        """ ;
    ] .

#
# Shape: academic_progress_shape
# Description: The student must have successfully passed exams for at least half of the required courses from the previous academic year.
#
:academic_progress_shape
    a sh:NodeShape ;
    sh:targetClass :Applicant ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "The student has not successfully passed at least half of the required courses from the previous year." ;
        sh:select """
            SELECT ?this
            WHERE {
                ?this :hasEducation ?edu .
                ?edu :passedCoursesCount ?passed .
                ?edu :totalCoursesCount ?total .
                FILTER ((?passed * 2) < ?total)
            }
        """ ;
    ] .

#
# Shape: residence_and_lease_shape
# Description: The student must be renting accommodation in a city different from their primary family residence, and the lease must be valid for at least six months.
#
:residence_and_lease_shape
    a sh:NodeShape ;
    sh:targetClass :Applicant ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "The student is not renting in a city different from their family, or the lease is not valid for at least six months." ;
        sh:select """
            SELECT ?this
            WHERE {
                ?this :hasCurrentResidence ?currentRes .
                ?this :hasFamilyResidence ?familyRes .
                
                ?currentRes :locatedIn ?currentCity .
                ?currentRes :residenceType ?resType .
                ?currentRes :leaseStartDate ?leaseStart .

                ?familyRes :locatedIn ?familyCity .

                # A lease is invalid if it started less than 6 months ago.
                # Violation if cities are the same OR type isn't "Rented" OR lease is too recent.
                FILTER (
                    (?currentCity = ?familyCity) ||
                    (?resType != "Rented") ||
                    (?leaseStart > (now() - "P6M"^^xsd:duration))
                )
            }
        """ ;
    ] .

#
# Shape: no_property_ownership_in_study_city_shape
# Description: Neither the student nor their parents can have full ownership or usufruct of a property in the city where the student is studying.
#
:no_property_ownership_in_study_city_shape
    a sh:NodeShape ;
    sh:targetClass :Applicant ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "The student or their parents own property in the city of study." ;
        sh:select """
            SELECT DISTINCT ?this
            WHERE {
                # Path to city of study
                ?this :hasEducation ?edu .
                ?edu :isEnrolledAt ?studyCity .
                
                # Paths to owned property locations (student or parents)
                {
                    ?this :ownsRealEstate ?prop .
                    ?prop :propertyLocation ?ownedCity .
                }
                UNION
                {
                    ?this :hasParent ?parent .
                    ?parent :ownsRealEstate ?prop .
                    ?prop :propertyLocation ?ownedCity .
                }
                
                # Constraint check
                FILTER (?studyCity = ?ownedCity)
            }
        """ ;
    ] .

#
# Shape: family_income_limit_shape
# Description: The annual family income must not exceed €30,000, with this limit increasing by €3,000 for each dependent child after the first.
#
:family_income_limit_shape
    a sh:NodeShape ;
    sh:targetClass :Applicant ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "The annual family income exceeds the allowed limit based on the number of dependent children." ;
        sh:select """
            SELECT ?this
            WHERE {
                {
                    SELECT ?this (SUM(DISTINCT ?incomeVal) AS ?totalIncome) (COUNT(DISTINCT ?depChild) AS ?childCount)
                    WHERE {
                        # Aggregate income from applicant and parents
                        {
                            ?this :hasIncome ?inc .
                            ?inc :amount ?incomeVal .
                        }
                        UNION
                        {
                            ?this :hasParent ?p .
                            ?p :hasIncome ?incP .
                            ?incP :amount ?incomeVal .
                        }
                        # Count dependent children (optional, as some applicants might not have parents listed)
                        OPTIONAL {
                            ?this :hasParent ?p .
                            ?p :hasChild ?depChild .
                            ?depChild :isDependent true .
                        }
                    }
                    GROUP BY ?this
                }
                # Calculate the income limit
                BIND(30000 + (3000 * IF(?childCount > 1, ?childCount - 1, 0)) AS ?limit)
                
                # Check for violation
                FILTER (?totalIncome > ?limit)
            }
        """ ;
    ] .

#
# Shape: total_property_area_limit_shape
# Description: The total area of real estate owned by the student or their parents must not cumulatively exceed 200 square meters, excluding properties in municipalities with a population under 3,000.
#
:total_property_area_limit_shape
    a sh:NodeShape ;
    sh:targetClass :Applicant ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "The total area of owned real estate (in municipalities with >3,000 inhabitants) exceeds 200 square meters." ;
        sh:select """
            SELECT ?this
            WHERE {
                {
                    SELECT ?this (SUM(?areaToSum) as ?totalArea)
                    WHERE {
                        # Union of student's and parents' properties
                        { ?this :ownsRealEstate ?prop . }
                        UNION
                        { 
                            ?this :hasParent ?parent .
                            ?parent :ownsRealEstate ?prop .
                        }
                        
                        ?prop :propertyAreaM2 ?area ;
                              :propertyLocation ?loc .
                        
                        # Population is optional; if missing, we assume it's over the threshold.
                        OPTIONAL { ?loc :municipalityPopulation ?pop . }
                        
                        # Only include area in the sum if population is >= 3000
                        BIND(IF(BOUND(?pop) && ?pop < 3000, 0, ?area) AS ?areaToSum)
                    }
                    GROUP BY ?this
                }
                # Check for violation
                FILTER (?totalArea > 200)
            }
        """ ;
    ] .